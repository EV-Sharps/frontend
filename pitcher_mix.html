<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>âš¾ Pitcher Mix</title>

	<!--
	<script type="text/javascript" src="test.js"></script>
	-->

	<script type="text/javascript" src="tabulator.min.js"></script>
	<script type="text/javascript" src="peity-vanilla.min.js"></script>
	<script type="text/javascript" src="flatpickr.min.js"></script>
	<link href="tabulator.min.css" rel="stylesheet">
	<link href="flatpickr.min.css" rel="stylesheet">
	<link href="style.css" rel="stylesheet">
	<script src="plotly-3.0.0.min.js" charset="utf-8"></script>
	<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
	<style>
		#tables {
			display: flex;
			width: 80%;
			justify-content: space-evenly;
			overflow: hidden;
		}
		#lefties, #righties {
			overflow-y: auto;
		}
		#table {
			width: auto;
		}
		.table {
			max-height: 150px;
		}
		#pitcher-name {
			text-align: center;
		}
		#pitcher-container {
			width: 80%;
  			justify-content: space-evenly;
		}
		#pitcher-tables {
			display: flex;
			justify-content: space-evenly;
		}
		h4 {
			margin: 0;
		}
		.games-bar{display:flex;align-items:center;gap:8px;width: 100%;}
		.nav{
			background:#0b1220;border:1px solid #1f2937;color:#e5e7eb;
			width:32px;height:32px;border-radius:8px;cursor:pointer;
			align-items: center;
		}
		.nav:hover{background:#0f172a}
		.games-scroller{
		display:flex;gap:12px;overflow-x:auto;padding:8px 4px;
		scroll-snap-type:x mandatory; -webkit-overflow-scrolling:touch;
		}
		.games-scroller::-webkit-scrollbar{height:6px}
		.games-scroller::-webkit-scrollbar-thumb{background:#1f2937;border-radius:4px}
		.game-card {
			scroll-snap-align:center;flex:0 0 auto;width:92px;
		    background:#0b1220;border:1px solid #1f2937;border-radius:12px;
		    padding:8px; text-align:center; color:#e5e7eb; text-decoration:none;
		    transition:transform .08s ease, background .15s ease;
		}
		.game-card.popular {
			border-color: gold;
		}
		.game-card:hover { background: #0f172a; transform: translateY(-1px); }
		.pair{display:flex;align-items:center;justify-content:center;gap:6px}
		.team{
			display:flex;flex-direction:column;align-items:center;gap:2px
			color: initial;
			text-decoration: none;
		}
		.team img{width:28px;height:28px;object-fit:contain}
		.code{font-size:11px;text-transform:uppercase;color:#c7d2fe}
		.at{font-size:10px;color:#94a3b8}
		.chev { opacity:.6 }
		.splits-toggle { 
			display:none; gap:8px; margin:8px 0 12px;
			justify-content: center;
		}
		.toggle-btn{
		  padding:6px 10px; border-radius:8px; border:1px solid #243449;
		  background:#0b1220; color:#e5e7eb; cursor:pointer; font-weight:600;
		}
		.batter-container h3 {
			margin-bottom: 0;
		}
		@media (max-width: 768px) {
			#table {
				flex: 1;
			}
			#pitcher-container {
				display: flex;
				flex-wrap: wrap;
			}
			#pitcher-container, #tables {
				width: 100%;
			}
			.splits-toggle {
				display: flex;
			}
			.toggle-btn.is-active{ border-color:#ffd45a; box-shadow:inset 0 0 0 1px rgba(255,212,90,.35); }
			.is-hidden{ display:none; }
		}
	</style>
</head>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-FX06BZ5MRL"></script>
<script>
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());

	gtag('config', 'G-FX06BZ5MRL');
</script>

<body>
	<div id="app">
		<header id="header">
			<div id="title">
				<h1>+EV Sharps</h1>
			</div>
			<div id="center-dropdown">
				<div class="select-wrapper">
					<select id="page-select"></select>
					<svg class="select-arrow" viewBox="0 0 20 20">
						<path d="M7 7l3 3 3-3" fill="none" stroke="currentColor" stroke-width="2"/>
					</svg>
				</div>
				<div class="select-wrapper">
					<select id="side-select">
						<option value="both">vs Both</option>
						<option value="l">vs LHB</option>
						<option value="r">vs RHB</option>
					</select>
					<svg class="select-arrow" viewBox="0 0 20 20">
						<path d="M7 7l3 3 3-3" fill="none" stroke="currentColor" stroke-width="2"/>
					</svg>
				</div>
			</div>
			<div id="auth-buttons">
				<button class="discord-login loggedOut" onclick="loginWithDiscord()">
					<img src="/logos/discord.png" alt="Discord logo">
					<span class="btn-text">Sign in with Discord</span>
				</button>
				<button class="gsi-material-button loggedOut" onclick="loginWithGoogle()">
				  <div class="gsi-material-button-state"></div>
				  <div class="gsi-material-button-content-wrapper">
					<div class="gsi-material-button-icon">
					  <svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" xmlns:xlink="http://www.w3.org/1999/xlink" style="display: block;">
						<path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path>
						<path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path>
						<path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path>
						<path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path>
						<path fill="none" d="M0 0h48v48H0z"></path>
					  </svg>
					</div>
					<span style="display: none;">Sign in with Google</span>
				  </div>
				</button>

				<span id="username" class="username loggedIn"></span>
				<button id="pricing" class="loggedOut" onclick="changePage('pricing')">Pricing</button>
				<button id="account" class="loggedIn" onclick="changePage('profile')">Profile</button>
				<button id="upgrade" class="loggedIn" onclick="changePage('pricing')">Upgrade ðŸŽ¯</button>
				<button id="logout" class="loggedIn" onclick="logout()">Logout</button>
			</div>
		</header>
		<main>
			<div id="table-container">
				<div class="games-bar">
					<button class="nav prev" aria-label="Previous">â€¹</button>
					<div id="games" class="games-scroller"></div>
					<button class="nav next" aria-label="Next">â€º</button>
				</div>
				<div id="pitcher-container">
					<h3 id="pitcher-name"></h3>
					<div id="pitcher-splits-toggle" class="splits-toggle" role="tablist" aria-label="Splits">
					    <button class="toggle-btn is-active" role="tab" aria-selected="true" data-target="l">LHB</button>
					    <button class="toggle-btn" role="tab" aria-selected="false" data-target="r">RHB</button>
					</div>
					<div id="pitcher-tables">
						<div class="split-panel" id="panel-l" role="tabpanel" aria-labelledby="tab-l">
							<div style="display: flex; justify-content: space-between;">
								<h4>vs LHB</h4>
								<div id="pitcher-hr-l"></div>
							</div>
							<div id="pitcher-table-l"></div>	
						</div>
						<div class="split-panel is-hidden" id="panel-r" role="tabpanel" aria-labelledby="tab-r">
							<div style="display: flex; justify-content: space-between;">
								<h4>vs RHB</h4>
								<div id="pitcher-hr-r"></div>
							</div>
							<div id="pitcher-table-r"></div>
						</div>
					</div>
				</div>
				<div id="tables">
					<div id="lefties"></div>
					<div id="righties" class="is-hidden"></div>
				</div>
				<div id="watermark">
					<img src="logos/logo.png">
				</div>
			</div>
		</main>
		<footer class="site-footer">
			<p>All content is for entertainment purposes only. +EV Sharps is not affiliated with MLB. <a href="/disclaimer">Read Full Terms</a></p>
		</footer>
	</main>
	<script type="text/javascript" src="shared.js"></script>
	<script src="auth.js"></script>
	<script type="text/javascript">
		PAGE = "pitcher_mix";
		let RES, TABLE;
		let HISTORICAL = {};
		let url = "";
		const windowURL = new URL(window.location.href);
		const URLParams = new URLSearchParams(windowURL.search);
		let DATE = URLParams.get("date");
		let MARK = URLParams.get("mark");
		let TODAY = getToday();
		let SPORT = "mlb";
		let PLAYER = URLParams.get("player");
		let PRETTY = URLParams.get("pretty");
		TEAM = URLParams.get("team") || "det";
		let SIDE = URLParams.get("side") ?? "both";

		if (MARK != undefined) {
			document.querySelector("#watermark").style.display = "initial";
			document.querySelector("#table-container").style["max-height"] = "initial";
			document.querySelector("#watermark").style.width = "20%";
		}

		document.querySelector("#side-select").value = SIDE;
		document.querySelector("#side-select").addEventListener("change", (event) => {
			SIDE = event.target.value;
			let url = new URL(window.location.href);
			const params = new URLSearchParams(window.location.search);
			params.set("side", SIDE);
			const newUrl = `${window.location.pathname}?${params.toString()}`;
			history.pushState({}, '', newUrl);
			formatMix(RES);
			TABLE.setData(RES);
		})

		window.addEventListener("resize", () => {
			MOBILE = window.innerWidth <= 600;
		});

		handleSession();

		function fetchMixData() {
			renderTable([]);
			fetch(API_BASE+`/api/pitcher_mix?team=${TEAM}`, {
				headers: { "Accept": "application/vnd.github.v3.raw" }
			}).then(response => response.json()).then(data => {
				data = data.data;
				formatMix(data);
				RES = data;
				renderGames(data.games);
				renderPitcherTable(data.pitcher);
				renderTable(data.batters);

				setTimeout(function() {
					if (PRETTY != undefined) {
						pretty_();
					}
					if (SIDE) {
						/*
						let col = SIDE === "both" ? "percs.hr_rate_percentile" : `percs.hr_${SIDE}_rate`
						TABLE.setSort([
							{column: col, dir: "desc"}
						])
						*/
					}
				}, 200);
			}).catch(err => console.log(err));
		}

		function safe(n){ return Number.isFinite(n) ? n : 0; }

		function formatMix(data) {
			const pitcher = data.pitcher;
			SIDE = pitcher.pitch_hand?.toLowerCase() || "both";
			for (side of ["l", "r"]) {
				if (!pitcher?.pitch) {
					continue;
				}
				const section = pitcher?.pitch[side];
				if (!section) continue;

				const entries = Object.entries(section).map(([type, stats]) => {
					return {
						type: type,
						...stats,
						n: stats["#"] || 0,
						percent: stats["%"] || 0,
						hr: stats.home_run || 0,
						brl: stats.is_barrel || 0,
						hh: stats.is_hard_hit || 0
					}
				});
				pitcher[`pitch_table_${side}`] = entries;
			}

			document.querySelector("#pitcher-hr-l").textContent = pitcher?.hr_pitch_l;
			document.querySelector("#pitcher-hr-r").textContent = pitcher?.hr_pitch_r;

			const top_pitches = getTopPitches(pitcher);
			const throws = pitcher.pitch_hand?.toLowerCase();
			const batters = data.batters || [];
			for (const row of batters.sort((a,b) => b.hr_pitch?.length - a.hr_pitch?.length)) {
				const section = row.pitch[SIDE];
				if (!section) continue;

				const entries = Object.entries(section).map(([type, stats]) => {
					let num = top_pitches[row.pitch_hand.toLowerCase()];
					if (num) {
						num = num.indexOf(type) === -1 ? 0 : num.indexOf(type) + 1;
					} else {
						num = "";
					}
					return {
						type: type,
						...stats,
						n: stats["#"] || 0,
						percent: stats["%"] || 0,
						hr: stats.home_run || 0,
						brl: stats.is_barrel || 0,
						hh: stats.is_hard_hit || 0,
						pitch_num: num
					}
				});
				row["pitch_table"] = entries;
			}
		}

		function getTopPitches(data) {
			const map = {};
			for (which of ["l", "r"]) {
				if (!data[`pitch_table_${which}`]) continue;
				const pitches = data[`pitch_table_${which}`].sort((a,b) => b.n - a.n).map(r => r.type);
				map[which] = pitches;
			}
			return map;
		} 

		function renderTable(data) {
			const tables = document.querySelector("#tables");
			const leftTable = document.querySelector("#lefties");
			const rightTable = document.querySelector("#righties");
			for (row of data) {
				const tableId = `table-${row.player.replaceAll(" ", "-")}`;
				const div = document.createElement("div");
				div.className = "batter-container";
				div.innerHTML = `
					<div style="display: flex; justify-content: space-between;align-items: flex-end;">
						<h3>${title(row.player)} (${row.pitch_hand.replace("B", "S")})</h3>
						<div>${(row[`hr_pitch_${SIDE}`] || []).slice(-7).join(",")}</div>
					</div>
					<div id="${tableId}" class="table"></div>
				`
				let which = "r";
				if (row.pitch_hand == "L" || (row.pitch_hand == "B" && SIDE == "r")) {
					leftTable.appendChild(div);
					which = "l";
				} else {
					rightTable.appendChild(div);
				}
				TABLE = new Tabulator("#"+tableId, {
					tooltipsHeader: true,
					placeholder:"Data Loading...",
					layout: "fitDataFill",
					responsiveLayout: MOBILE ? "" : "",
					autoResize: true,
					data: row.pitch_table,
					initialSort: [
						{ column:"n", dir:"desc" },
					],
					columnDefaults: {
						vertAlign: "middle",
						hozAlign: "center",
						resizable: false,
						headerSortStartingDir: "desc"
					},
					groupToggleElement: "header",
					columns: [
						{ title:"Type", field:"type", width:75, formatter: pitchFormatter, hozAlign: "left" },
						{ title:"#", field:"n", sorter:"number", width:50 },
						{ title:"%", field:"percent", sorter:"number", formatter: percentFormatter, width:50 },
						{ title:"BA", field:"ba", sorter:"number", width:45, formatter: pitchPercentileFormatter },
						{ title:"WOBA", field:"woba", sorter:"number", width:45, formatter: pitchPercentileFormatter, visible: true },
						{ title:"SLG", field:"slg", sorter:"number", width:45, formatter: pitchPercentileFormatter },
						{ title:"ISO", field:"iso", sorter:"number", width:45, formatter: pitchPercentileFormatter },
						{ title: "Home Runs", columns: [
							{ title:"HR", field:"hr", sorter:"number", width:40, formatter: pitchPercentileFormatter },
							{ title:"Rate", field:"hr_rate", sorter:"number", width:45, formatter: pitchPercentileFormatter },
						]},
						{ title:"BRL", field:"brl_rate", sorter:"number", width:45, formatter: pitchPercentileFormatter },
						{ title:"HH", field:"hh_rate", sorter:"number", width:45, formatter: pitchPercentileFormatter },
					],
				});
			}
		}

		function logoSrc(code) {
			// assumes logos live at logos/mlb/{team}.png
			return `logos/mlb/${String(code).toLowerCase()}.png`;
		}

		function renderGames(data) {
			const games = document.querySelector("#games");
			for (game of data) {
				const [a,h] = game.toUpperCase().split(" @ ");
				const div = document.createElement("div");
				div.className = `game-card ${[a,h].includes(TEAM.toUpperCase()) ? "popular" : ""}`;
				div.innerHTML = `
				<div class="pair">
					<a class="team" href="/pitcher_mix${HTML}?team=${a.toLowerCase()}">
						<img src="${logoSrc(a)}" alt="${a} logo" />
						<span class="code">${a}</span>
					</a>
					<span class="at">@</span>
					<a class="team" href="/pitcher_mix${HTML}?team=${h.toLowerCase()}">
						<img src="${logoSrc(h)}" alt="${h} logo" />
						<span class="code">${h}</span>
					</a>
				</div>`;
				games.appendChild(div);
			}
		}

		function renderPitcherTable(data) {
			document.querySelector("#pitcher-name").textContent =`${title(data.player)} (${data.pitch_hand})`;
			for (side of ["l", "r"]) {
				const tableId = `pitcher-table-${side}`;
				TABLE = new Tabulator("#"+tableId, {
					tooltipsHeader: true,
					placeholder:"Data Loading...",
					layout: "fitDataFill",
					responsiveLayout: MOBILE ? "" : "",
					autoResize: true,
					data: data[`pitch_table_${side}`],
					initialSort: [
						{ column:"n", dir:"desc" },
					],
					columnDefaults: {
						vertAlign: "middle",
						hozAlign: "center",
						resizable: false,
						headerSortStartingDir: "desc"
					},
					groupToggleElement: "header",
					columns: [
						{ title:"Type", field:"type", width:75, formatter: pitchFormatter, hozAlign: "left" },
						{ title:"#", field:"n", sorter:"number", width:50 },
						{ title:"%", field:"percent", sorter:"number", formatter: percentFormatter, width:50 },
						{ title:"BA", field:"ba", sorter:"number", width:45, formatter: pitchPercentileFormatter },
						{ title:"WOBA", field:"woba", sorter:"number", width:45, formatter: pitchPercentileFormatter, visible: true },
						{ title:"SLG", field:"slg", sorter:"number", width:45, formatter: pitchPercentileFormatter },
						{ title:"ISO", field:"iso", sorter:"number", width:45, formatter: pitchPercentileFormatter },
						{ title: "Home Runs", columns: [
							{ title:"HR", field:"hr", sorter:"number", width:40, formatter: pitchPercentileFormatter },
							{ title:"Rate", field:"hr_rate", sorter:"number", width:45, formatter: pitchPercentileFormatter },
						]},
						{ title:"BRL", field:"brl_rate", sorter:"number", width:45, formatter: pitchPercentileFormatter },
						{ title:"HH", field:"hh_rate", sorter:"number", width:45, formatter: pitchPercentileFormatter },
					],
				});
			}
		}

		function groupByGame() {
			if (!TABLE.options.groupBy) {
				TABLE.setGroupBy("game");
			} else {
				TABLE.setGroupBy();
			}
		}

		 const gamesEl = document.querySelector("#games");
		const prev = document.querySelector(".nav.prev");
		const next = document.querySelector(".nav.next");
		const scrollByPx = 320;

		prev.onclick = () => gamesEl.scrollBy({ left: -scrollByPx, behavior: "smooth" });
		next.onclick = () => gamesEl.scrollBy({ left:  scrollByPx, behavior: "smooth" });

		(function initSplitsToggle(){
			const toggle = document.getElementById('pitcher-splits-toggle');
			const panels = {
				l: document.getElementById('panel-l'),
				r: document.getElementById('panel-r'),
				lefties: document.getElementById("lefties"),
				righties: document.getElementById("righties"),
			};

			toggle.addEventListener('click', (e) => {
				const btn = e.target.closest('.toggle-btn');
				if (!btn) return;

				// update active button
				toggle.querySelectorAll('.toggle-btn').forEach(b => {
				 	b.classList.toggle('is-active', b === btn);
					b.setAttribute('aria-selected', b === btn ? 'true' : 'false');
				});

				const side = btn.dataset.target;
				lefties.classList.toggle("is-hidden", side === "r");
				righties.classList.toggle("is-hidden", side === "l");
				panels.l.classList.toggle('is-hidden', side !== 'l');
				panels.r.classList.toggle('is-hidden', side !== 'r');
			});
		})();
	</script>
</body>
</html>
