<!DOCTYPE html>
<html>
<head>
  <title>Finishing Upgrade...</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 100px;
    }
    .spinner {
      border: 4px solid #eee;
      border-top: 4px solid #09f;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <h2>Finalizing your upgrade...</h2>
  <p>This usually takes just a few seconds.</p>
  <div class="spinner"></div>

  <script type="text/javascript" src="shared.js"></script>
  <script src="auth.js"></script>
  <script type="module">
    async function waitForUpgrade() {
      const sessionRes = await SB.auth.getSession();
      const userId = sessionRes.data.session?.user?.id;
      if (!userId) {
        document.body.innerHTML = '<h2>Please log in to finish upgrade.</h2>';
        return;
      }

      const maxTries = 15;
      let tries = 0;

      while (tries < maxTries) {
        const { data: profile } = await SB
          .from('profiles')
          .select('tier')
          .eq('id', userId)
          .single();

        if (profile?.tier !== 'free') {
          window.location.href = '/profile';
          return;
        }

        await new Promise(r => setTimeout(r, 2000));
        tries++;
      }

      document.body.innerHTML = `<h2>Still finalizing...</h2><p>Please try again later or contact support.</p>`;
    }

    waitForUpgrade();
  </script>
</body>
</html>
